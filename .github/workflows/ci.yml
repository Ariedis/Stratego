name: CI

on:
  push:
    branches:
      - main

permissions:
  issues: write

jobs:
  build-and-test:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.12"

      - name: Install dependencies
        run: pip install -e ".[dev]"

      - name: Lint (ruff)
        run: ruff check src/

      - name: Type check (mypy)
        run: mypy src/ --exclude src/Tests/

      - name: Build wheel
        run: |
          pip install hatchling
          pip wheel . --no-deps -w dist/

      - name: Run tests
        run: |
          pytest src/Tests/ \
            --cov=src \
            --cov-report=term-missing \
            -v

      - name: Create issue on build failure
        if: failure()
        uses: actions/github-script@v7
        with:
          script: |
            const runUrl = `${context.serverUrl}/${context.repo.owner}/${context.repo.repo}/actions/runs/${context.runId}`;
            const title = `CI build failure on \`${context.ref}\` â€” ${context.sha.slice(0, 7)}`;
            const body = [
              '## CI Build Failure',
              '',
              `A CI build failure was detected on the \`${context.ref}\` branch.`,
              '',
              `| Field | Value |`,
              `|-------|-------|`,
              `| **Run** | [View workflow run](${runUrl}) |`,
              `| **Commit** | \`${context.sha}\` |`,
              `| **Triggered by** | @${context.actor} |`,
              '',
              '## Action Required',
              '',
              'Please investigate the failed steps in the workflow run linked above and apply the necessary fixes.',
              '',
              '_This issue was automatically created by the CI pipeline and assigned to the software developer agent for triage._',
            ].join('\n');

            for (const [name, color, description] of [
              ['bug', 'd73a4a', "Something isn't working"],
              ['ci-failure', 'e11d48', 'CI pipeline failure'],
            ]) {
              try {
                await github.rest.issues.createLabel({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  name,
                  color,
                  description,
                });
              } catch (_) {
                // Label already exists
              }
            }

            await github.rest.issues.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title,
              body,
              labels: ['bug', 'ci-failure'],
              assignees: ['copilot'],
            });
